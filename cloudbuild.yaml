# cloudbuild.yaml (Despliegue en App Engine Flexible)
steps:
  # ========================================
  # âœ… PASO 1: Ejecutar Pruebas con Pytest
  # ========================================
  # (Sin cambios, Â¡las pruebas son fundamentales!)
  - name: 'python:3.9-slim'
    entrypoint: 'bash'
    id: 'Ejecutar Pruebas' # ID para referencia (opcional)
    args:
    - '-c'
    - |
      echo "--- ğŸ§ª Instalando dependencias para pruebas ---" && \
      pip install -r requirements.txt && \
      echo "--- â–¶ï¸ Ejecutando pruebas (pytest) ---" && \
      python -m pytest tests/

  # ==========================================
  # ğŸ³ PASO 2: Construir la imagen Docker
  # ==========================================
  # (Necesario para App Engine Flex con runtime 'custom')
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Construir Imagen'
    args:
    - 'build'
    - '-t'
    # ğŸ“ Ruta en Artifact Registry (Â¡usando $PROJECT_ID!)
    - 'us-central1-docker.pkg.dev/${PROJECT_ID}/devops-images/gcp-repo-01:$COMMIT_SHA'
    - '.' # Directorio de contexto (donde estÃ¡ tu Dockerfile)
    waitFor: ['Ejecutar Pruebas'] # Asegura que las pruebas pasen primero

  # ====================================================
  # â¬†ï¸ PASO 3: Subir (push) la imagen a Artifact Registry
  # ====================================================
  # (La imagen debe estar accesible para App Engine)
  - name: 'gcr.io/cloud-builders/docker'
    id: 'Subir Imagen'
    args:
     - 'push'
     # ğŸ“ La misma ruta de la imagen que construimos
     - 'us-central1-docker.pkg.dev/${PROJECT_ID}/devops-images/gcp-repo-01:$COMMIT_SHA'
    waitFor: ['Construir Imagen'] # Asegura que la imagen se construyÃ³

  # ====================================================
  # ğŸ”¥ PASO 4: Desplegar a App Engine Flexible Environment ğŸ”¥
  # ====================================================
  # Â¡AquÃ­ estÃ¡ el cambio principal!
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Desplegar a App Engine'
    entrypoint: gcloud
    args:
      - 'app'         # Comando principal de App Engine
      - 'deploy'      # AcciÃ³n de despliegue
      # ğŸ“„ 'app.yaml' # Opcional: gcloud lo busca por defecto.
                      # Especificar si tiene otro nombre o ruta.
      - '--image-url' # ğŸ–¼ï¸ Usamos la imagen que SUBIMOS
      - 'us-central1-docker.pkg.dev/${PROJECT_ID}/devops-images/gcp-repo-01:$COMMIT_SHA'
      - '--project'   # ğŸ†” Especifica el proyecto (buena prÃ¡ctica)
      - '${PROJECT_ID}'
      - '--version'   # ğŸ·ï¸ Etiqueta la versiÃ³n con el commit (opcional pero Ãºtil)
      - '${COMMIT_SHA}'
      - '--quiet'     # ğŸ¤« Evita prompts interactivos (Â¡esencial en CI/CD!)
      # '--stop-previous-version' # Opcional: Detiene la versiÃ³n anterior tras el deploy exitoso
      # '--promote' # Opcional: (por defecto es true) Dirige todo el trÃ¡fico a la nueva versiÃ³n
    waitFor: ['Subir Imagen'] # Asegura que la imagen estÃ© en el registro

# ======================================
# ğŸ–¼ï¸ IMÃGENES A SUBIR (POST-BUILD)
# ======================================
# (Redundante por el PASO 3 explÃ­cito, pero es la forma estÃ¡ndar)
images:
  - 'us-central1-docker.pkg.dev/${PROJECT_ID}/devops-images/gcp-repo-01:$COMMIT_SHA'

# ======================================
# âš™ï¸ SUSTITUCIONES (Opcional)
# ======================================
# $PROJECT_ID y $COMMIT_SHA son automÃ¡ticas. Puedes aÃ±adir las tuyas:
# substitutions:
#   _MY_REGION: 'us-central1'
#   _MY_SERVICE_NAME: 'mi-servicio-appengine'